version: '3.8'

services:

  # 1. Base de Datos PostgreSQL
  db:
    image: postgres:${POSTGRES_TAG:-15-alpine}
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 2. Broker de Mensajes RabbitMQ
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq_broker
    restart: always
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS}

  # 3. Microservicio API (FileIngestor.API)
  fileingestor-api:
    build:
      context: .
      dockerfile: FileIngestor.API/Dockerfile
    image: fileingestorapi
    container_name: fileingestor_api
    restart: always
    ports:
      - "8081:8080"
    depends_on:
      - db
      - rabbitmq
      - seaweedfs-master
      - redis
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}"
      Redis__RedisConnection: "redis:6379,password=Peru2412,abortConnect=false"
      Redis__InstanceName: "AtlanticApp:"
      rabbitmq__host: "rabbitmq"
      rabbitmq__port: 5672
      rabbitmq__username: ${RABBIT_USER}
      rabbitmq__password: ${RABBIT_PASS}
      JwtSettings__Secret: ${JWT_SECRET:-EstaEsUnaClaveSuperSecretaDeAlMenos32CaracteresParaJWT}
      JwtSettings__Issuer: "AtlanticApp.API"
      JwtSettings__Audience: "AtlanticApp.Clients"
      SeaweedFs__MasterUrl: "http://seaweedfs-master:9333"

  # 4. Microservicio Worker (DataProcessor.Worker) 
  dataprocesor-worker:
    build:
      context: .
      dockerfile: DataProcessor.Worker/Dockerfile
    image: dataprocesorworker
    container_name: dataprocesor_worker
    restart: always
    depends_on:
      - db
      - rabbitmq
      - redis
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}"
      Redis__RedisConnection: "redis:6379,password=Peru2412,abortConnect=false"
      Redis__InstanceName: "AtlanticApp:"
      rabbitmq__host: "rabbitmq"
      rabbitmq__port: 5672
      rabbitmq__username: ${RABBIT_USER}
      rabbitmq__password: ${RABBIT_PASS}
      SeaweedFs__MasterUrl: "http://seaweedfs-master:9333"

  # 5. Microservicio Worker de Notificaci√≥n (Notification.Worker)
  notification-worker:
    build:
      context: .
      dockerfile: Notification.Worker/Dockerfile
    image: notificationworker
    container_name: notification_worker
    restart: always
    depends_on:
      - db
      - rabbitmq
    environment:
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}"
      rabbitmq__host: "rabbitmq"
      rabbitmq__port: 5672
      rabbitmq__username: ${RABBIT_USER}
      rabbitmq__password: ${RABBIT_PASS}
      MailSettings__SmtpHost: "smtp.example.com"
      MailSettings__SmtpPort: 587
      MailSettings__SmtpUser: "user-name"
      MailSettings__SmtpPass: "password"
      MailSettings__FromEmail: "no-reply@atlanticapp.com"

  # 6. SeaweedFS Master
  seaweedfs-master:
    image: chrislusf/seaweedfs
    command: "master -ip=seaweedfs-master -port=9333"
    ports:
      - "9333:9333"
      - "19333:19333"

  # 7. SeaweedFS Volume
  seaweedfs-volume:
    image: chrislusf/seaweedfs
    command: "volume -ip=seaweedfs-volume -port=8080 -mserver=seaweedfs-master:9333"
    ports:
      - "8080:8080"
    depends_on:
      - seaweedfs-master

  # 8. Microservicio API de Consulta (DataProcessor.Api)
  dataprocesor-api:
    build:
      context: .
      dockerfile: DataProcessor.Api/Dockerfile
    image: dataprocesorapi
    container_name: dataprocesor_api
    restart: always
    ports:
      - "8082:8080"
    depends_on:
      - db
      - redis
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}"
      Redis__RedisConnection: "redis:6379,password=Peru2412,abortConnect=false"
      Redis__InstanceName: "AtlanticApp:"

  # 9. Servidor Redis
  redis:
    image: redis:alpine
    container_name: redis_cache
    restart: always
    command: redis-server --requirepass Peru2412
    ports:
      - "6379:6379"

volumes:
  postgres_data: